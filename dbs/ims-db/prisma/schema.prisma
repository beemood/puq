generator client {
  provider = "prisma-client-js"
  output   = "../generated"
}

generator zodGenerator {
  provider = "zod-generator"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Locations
model Store {
  /// Unique local integer identifier (system-input)
  id Int @id @default(autoincrement())

  /// Defines the creation timestamp (system-input)
  createdAt DateTime @default(now())

  /// Defines the modification timestamp (system-input)
  updatedAt DateTime @updatedAt

  /// Defines deletion timestamp (system-input)
  deletedAt DateTime?

  /// Unique store name s
  name String @unique @db.VarChar(255)

  /// Add required critical information about the store if any
  description String?

  /// This field can be generated using `slugExtention` provided 
  /// by `@puq/prisma-extentions`
  slug String @unique

  /// List of product quantities in this store
  quantities Quantity[]

  /// List of products tracted by serial numbers instead of by quantity in this store
  serials SerialNumber[]

  /// List of shelves in this store
  shelves Shelf[]

  /// Define if this store is readonly. 
  /// Readonly entries cannot be updated by the client application but super user
  readonly Boolean @default(false)

  /// List of discount in this store
  storeDiscounts StoreDiscount[]

  @@index([name])
  @@index([slug])
}

model Shelf {
  /// Unique local integer identifier (system-input)
  id Int @id @default(autoincrement())

  /// Defines the creation timestamp (system-input)
  createdAt DateTime @default(now())

  /// Defines the modification timestamp (system-input)
  updatedAt DateTime @updatedAt

  /// Defines deletion timestamp (system-input)
  deletedAt DateTime?

  /// Shelf name (e.g  "A", "B", "AA", "BB")
  name String @db.VarChar(255)

  /// Defines a description or required information about the shelf 
  /// (e.g metal, wood, heavy duty)
  description String?

  /// Defiens aisle/section (e.g "1", "2")
  aisle String @db.VarChar(255)

  /// Defines the rack number  (e.g 1, 2)
  rack Int

  /// Defines the level/floor number  (e.g 1, 2)
  level Int

  /// Shelf store
  store Store @relation(fields: [storeId], references: [id])

  /// Shelf store id
  storeId Int

  /// Defines if the shelf data is readonly or not. 
  /// Readonly entires cannot be updated by client application
  readonly Boolean @default(false)

  @@unique([name, storeId])
  @@unique([storeId, aisle, rack, level])
  @@index([storeId])
  @@index([aisle, rack, level])
}

model Category {
  /// Unique local integer identifier (system-input)
  id Int @id @default(autoincrement())

  /// Defines the creation timestamp (system-input)
  createdAt DateTime @default(now())

  /// Defines the modification timestamp (system-input)
  updatedAt DateTime @updatedAt

  /// Defines deletion timestamp (system-input)
  deletedAt DateTime?

  /// Unqiue category  name (e.g Electronics)
  name String @unique @db.VarChar(255)

  /// Defines a category description
  description String?

  /// Defines a slug which is a url friendly category name
  /// Slugs are used in urls for better user experience
  slug String @unique

  /// Defines parent category (e.g PC and Laptop are cateogry. 
  /// Electronics is the parent category)
  parent Category? @relation("children", fields: [parentId], references: [id])

  /// Parent category id
  parentId Int?

  /// List of child categories 
  children Category[] @relation("children")

  /// List of products belong to this category
  products Product[]

  /// List of category-discounts
  categoryDiscounts CategoryDiscount[]

  /// Defines if the category is readonly
  /// which means it cannot be updated by the client application
  /// This field is to protect the default categories data (common categories provided by the system) from deletion.
  readonly Boolean @default(false)

  @@index([parentId])
  @@index([name])
  @@index([slug])
}

/// Tag table does not have a specific role in this database. 
/// It can be used for any kind of tracking to help identify products
model Tag {
  /// Unique local integer identifier (system-input)
  id Int @id @default(autoincrement())

  /// Defines the creation timestamp (system-input)
  createdAt DateTime @default(now())

  /// Defines the modification timestamp (system-input)
  updatedAt DateTime @updatedAt

  /// Defines deletion timestamp (system-input)
  deletedAt DateTime?

  /// Unique tag name
  name String @unique @db.VarChar(255)

  /// Product tag map table 
  productTags ProductTag[]

  @@index([name])
}

/// Product-tag map table 
model ProductTag {
  /// Unique local integer identifier (system-input)
  id Int @id @default(autoincrement())

  /// Defines the creation timestamp (system-input)
  createdAt DateTime @default(now())

  /// Defines the modification timestamp (system-input)
  updatedAt DateTime @updatedAt

  /// Defines deletion timestamp (system-input)
  deletedAt DateTime?

  /// Product relation
  product Product @relation(fields: [productId], references: [id])

  /// Product id
  productId Int

  /// Tag relation 
  tag Tag @relation(fields: [tagId], references: [id])

  /// Tag id
  tagId Int

  @@unique([productId, tagId])
  @@index([productId])
  @@index([tagId])
}

model Product {
  id Int @id @default(autoincrement())

  /// Universal unique indentifier to identify product accross the applications
  uuid String @default(uuid()) @db.Uuid

  /// Defines the creation timestamp (system-input)
  createdAt DateTime @default(now())

  /// Defines the modification timestamp (system-input)
  updatedAt DateTime @updatedAt

  /// Defines deletion timestamp (system-input)
  deletedAt DateTime?

  /// Unique product name
  name String @unique @db.VarChar(255)

  /// Product description 
  description String?

  /// Url friendly product name (e.g for "Product Name" to "product-name")
  slug String @unique

  /// Unqiue product stock keeping unite code (e.g "PC-8I-GREY-008")
  sku String @unique @db.VarChar(255)

  /// Unique product code (e.g "1234567890123")
  upc String @unique @db.VarChar(255)

  /// Product model 
  model String? @db.VarChar(255)

  /// Product category relation
  category Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  /// Product category id
  categoryId Int?

  /// Product type. 
  /// Product type is used to indentify the applicable tax rate
  type ProductType @relation(fields: [typeId], references: [id])

  //// Product type id
  typeId Int

  /// Parent product relation 
  parent Product? @relation("variants", fields: [parentId], references: [id], onDelete: SetNull)

  /// Parent product id
  parentId Int?

  /// List of product variatns belongs to this product
  variants Product[] @relation("variants")

  /// List of product quantities belongs to this product
  quantities Quantity[]

  /// List of product serial numbers belongs to this product 
  serialNumbers SerialNumber[]

  /// List of product prices belongs to this product 
  prices Price[]

  /// List of product-tags 
  productTags ProductTag[]

  /// Discounts that might belong to multiple products
  discounts ProductDiscount[]

  /// Discounts that only belongs to this product
  ownDiscounts Discount[]

  /// Defines if the product is readonly or not
  /// Readonly entries cannot be updated by the client application
  readonly Boolean @default(false)

  @@index([categoryId])
  @@index([typeId])
  @@index([parentId])
  @@index([sku])
  @@index([upc])
  @@index([name])
}

model Quantity {
  /// Unique local integer identifier (system-input)
  id Int @id @default(autoincrement())

  /// Defines the creation timestamp (system-input)
  createdAt DateTime @default(now())

  /// Defines the modification timestamp (system-input)
  updatedAt DateTime @updatedAt

  /// Defines deletion timestamp (system-input)
  deletedAt DateTime?

  /// Defines the number of items available in the store
  quantity Int

  /// Defines the minimum number of items required in the store. 
  /// If the quantity falls under minimum quantity, 
  /// the system create an actionable notification
  minQuantity Int?

  /// Product relation
  product Product @relation(fields: [productId], references: [id])

  /// Product id
  productId Int

  /// Store relation 
  store Store @relation(fields: [storeId], references: [id])

  /// Store id
  storeId Int

  /// Defines if the entry is readonly or not
  /// Readonly entries cannot be updated by the client application 
  readonly Boolean @default(false)

  @@unique([storeId, productId])
  @@index([productId])
  @@index([storeId])
}

model SerialNumber {
  /// Unique local integer identifier (system-input)
  id Int @id @default(autoincrement())

  /// Defines the creation timestamp (system-input)
  createdAt DateTime @default(now())

  /// Defines the modification timestamp (system-input)
  updatedAt DateTime @updatedAt

  /// Defines deletion timestamp (system-input)
  deletedAt DateTime?

  /// Product serial number 
  serialNumber String @unique

  /// Defines if the product with the serial number is in stock or sold
  isInStock Boolean @default(true)

  /// Product relation 
  product Product @relation(fields: [productId], references: [id])

  /// Product id
  productId Int

  /// Store relation 
  store Store @relation(fields: [storeId], references: [id])

  /// Store id
  storeId Int

  /// Defines if the entry is readonly or not 
  /// Readonly entries cannot be modified or deleted by the client application 
  readonly Boolean @default(false)

  @@index([productId])
  @@index([storeId])
  @@index([isInStock])
}

// Price Tables 
model Price {
  /// Unique local integer identifier (system-input)
  id Int @id @default(autoincrement())

  /// Defines the creation timestamp (system-input)
  createdAt DateTime @default(now())

  /// Defines the modification timestamp (system-input)
  updatedAt DateTime @updatedAt

  /// Defines deletion timestamp (system-input)
  deletedAt DateTime?

  /// Defines the product price
  price Decimal @db.Decimal(10, 2)

  /// Defines the date from which this price is effective
  effectiveFrom DateTime

  /// Defines the date till which this price is effective
  effectiveTo DateTime?

  /// Product relation 
  product Product @relation(fields: [productId], references: [id])

  /// Product id
  productId Int

  /// Defines if the entry is readonly or not
  /// Readonly entries cannot be updated by the client application
  readonly Boolean @default(false)

  @@unique([productId, effectiveFrom])
  @@index([productId])
  @@index([effectiveFrom])
  @@index([effectiveTo])
}

enum DiscountType {
  /// (e.g $10)
  FIXED_VALUE
  /// (e.g %10)
  PERCENT_VALUE
  /// No discount but free shipping
  FREE_SHIPPING

  /// Discount is applied for the next_purchase
  NEXT_PURCHASE
}

enum DiscountTarget {
  /// Discount for all products
  ALL_PRODUCTS

  /// Discount for a single product (requires product id)
  SINGLE_PRODUCT

  /// Discount for a category/categories
  PRODUCT_CATEGORY

  /// Discount for specific product types such as "Tobacco"
  PRODUCT_TYPE
}

model Discount {
  /// Unique local integer identifier (system-input)
  id Int @id @default(autoincrement())

  /// Defines the creation timestamp (system-input)
  createdAt DateTime @default(now())

  /// Defines the modification timestamp (system-input)
  updatedAt DateTime @updatedAt

  /// Defines deletion timestamp (system-input)
  deletedAt DateTime?

  /// Discount name 
  name String @unique

  /// Discount code 
  code String @unique

  /// Defines detailed discount description 
  description String?

  /// Discount value can be percent or fixed value 
  /// (e.g $100 , %10)
  discountValue Decimal? @db.Decimal(10, 2)

  /// Conditional value for volumen discount 
  /// (e.g unitQuantity = 3 then apply %10 discount or regular price)
  minQuantity Int?

  /// Conditional value for price discount
  /// (e.g unitPrice = $100 then apply the discount only to the items sales more than $100
  minSubtotal Decimal? @db.Decimal(10, 2)

  /// These fields are crucial for historical accuracy. 
  /// They define the time range during which this specific rate was or is valid. 
  /// Tax rates change frequently, so the system must know which rate to apply 
  /// for a transaction on any given date.
  effectiveFrom DateTime
  effectiveTo   DateTime?

  /// Defines the target product or product group 
  target DiscountTarget

  /// Single product that have this discount
  product   Product? @relation(fields: [productId], references: [id])
  productId Int?

  /// List of product-discount map
  productDiscounts ProductDiscount[]

  /// List of store-discount map
  storeDiscounts StoreDiscount[]

  /// List of category-discount map
  categoryDiscounts CategoryDiscount[]

  /// List of product-type-discount map

  productTypeDiscounts ProductTypeDiscount[]

  /// Defines if the entry is readonly or not
  /// Readonly entries cannot be updated by the client application
  readonly Boolean @default(false)

  @@index([name])
  @@index([code])
  @@index([effectiveFrom, effectiveTo])
  @@index([discountValue])
}

model ProductDiscount {
  /// Unique local integer identifier (system-input)
  id Int @id @default(autoincrement())

  /// Defines the creation timestamp (system-input)
  createdAt DateTime @default(now())

  /// Defines the modification timestamp (system-input)
  updatedAt DateTime @updatedAt

  product   Product @relation(fields: [productId], references: [id])
  productId Int

  discount   Discount @relation(fields: [discountId], references: [id])
  discountId Int

  /// Defines if the entry is readonly or not
  /// Readonly entries cannot be updated by the client application
  readonly Boolean @default(false)

  @@unique([productId, discountId])
  @@index([productId])
}

model StoreDiscount {
  /// Unique local integer identifier (system-input)
  id Int @id @default(autoincrement())

  /// Defines the creation timestamp (system-input)
  createdAt DateTime @default(now())

  /// Defines the modification timestamp (system-input)
  updatedAt DateTime @updatedAt

  discount   Discount @relation(fields: [discountId], references: [id])
  discountId Int

  store   Store @relation(fields: [storeId], references: [id])
  storeId Int

  /// Defines if the entry is readonly or not
  /// Readonly entries cannot be updated by the client application
  readonly Boolean @default(false)

  @@unique([storeId, discountId])
  @@index([storeId])
}

model CategoryDiscount {
  /// Unique local integer identifier (system-input)
  id Int @id @default(autoincrement())

  /// Defines the creation timestamp (system-input)
  createdAt DateTime @default(now())

  /// Defines the modification timestamp (system-input)
  updatedAt DateTime @updatedAt

  category   Category @relation(fields: [categoryId], references: [id])
  categoryId Int

  discount   Discount @relation(fields: [discountId], references: [id])
  discountId Int

  /// Defines if the entry is readonly or not
  /// Readonly entries cannot be updated by the client application
  readonly Boolean @default(false)

  @@unique([categoryId, discountId])
  @@index([categoryId])
}

model ProductTypeDiscount {
  /// Unique local integer identifier (system-input)
  id Int @id @default(autoincrement())

  /// Defines the creation timestamp (system-input)
  createdAt DateTime @default(now())

  /// Defines the modification timestamp (system-input)
  updatedAt DateTime @updatedAt

  productType   ProductType @relation(fields: [productTypeId], references: [id])
  productTypeId Int

  discount   Discount @relation(fields: [discountId], references: [id])
  discountId Int

  /// Defines if the entry is readonly or not
  /// Readonly entries cannot be updated by the client application
  readonly Boolean @default(false)

  @@unique([productTypeId, discountId])
  @@index([productTypeId])
}

// Tax tables

/// The ProductType model defines categories of goods or services.
/// In tax systems, different types of products are often taxed 
/// at different rates or might be exempt.
/// - General Merchandise (Tangible Goods): The default category for physical goods 
///   at the standard retail rate.	State + County + City Rate (e.g., 7.5%)
/// - Non-essential Clothing	Clothing that is not eligible for exemptions
///  (often high-priced or specialized).	State + County + City Rate (e.g., 7.5%)
/// - Prepared Food	Food that is ready for immediate consumption, typically
///   sold by restaurants or delis.	Often the General Rate, but sometimes 
///   a Higher rate (e.g., 10%)
/// - Alcoholic Beverages	Always taxable, frequently subject to 
///   the General Rate plus additional excise taxes.	General Rate + Excise Taxes
/// - Tobacco/Vape Products	Always taxable and subject to the General
///   Rate plus additional excise taxes.	General Rate + Excise Taxes
/// - Digital Goods/Software	Prewritten software, streaming services, 
///   and digital downloads. Taxability varies widely.	
///   General Rate (in many states/jurisdictions)
model ProductType {
  /// Unique local integer identifier (system-input)
  id Int @id @default(autoincrement())

  /// Defines the creation timestamp (system-input)
  createdAt DateTime @default(now())

  /// Defines the modification timestamp (system-input)
  updatedAt DateTime @updatedAt

  /// Defines deletion timestamp (system-input)
  deletedAt DateTime?

  /// The unique name of the product category 
  /// (e.g., "General Merchandise," "Prepared Food," "Prescription Drugs"). 
  /// This is critical for matching tax rules.
  name String @unique @db.VarChar(255)

  /// An optional field for a detailed explanation of the product type.
  description String?

  /// List of products of this product type
  products Product[]

  /// List of tax rates for this product type
  taxRates TaxRate[]

  /// List of product-type-discount map
  productTypeDiscounts ProductTypeDiscount[]

  /// Defines if the entry is readonly or not
  /// Readonly entries cannot be updated by the client application
  readonly Boolean @default(true)

  @@index([name])
}

/// The Jurisdiction model represents a governmental area that has the authority 
/// to levy a tax (e.g., a country, state, county, or city). 
/// Taxes often stack, meaning a product might be subject to 
/// state, county, and city taxes simultaneously.
model Jurisdiction {
  /// Unique local integer identifier (system-input)
  id Int @id @default(autoincrement())

  /// Defines the creation timestamp (system-input)
  createdAt DateTime @default(now())

  /// Defines the modification timestamp (system-input)
  updatedAt DateTime @updatedAt

  /// Defines deletion timestamp (system-input)
  deletedAt DateTime?

  /// A unique identifier often used in the U.S. (Federal Information Processing Standards) 
  /// to denote geographical entities like counties and states.
  fipsCode String @unique

  /// The common name of the jurisdiction (e.g., "State of California," "Cook County").
  name String

  /// Describes the type of jurisdiction (e.g., "State," "County," "City").
  level String

  /// These fields implement a self-referencing hierarchical relationship
  /// (a tree structure). This allows one to model how jurisdictions are nested 
  /// (e.g., a city is a child of a county, which is a child of a state). 
  /// This is vital for calculating stacked taxes.
  parent   Jurisdiction? @relation("children", fields: [parentId], references: [id])
  parentId Int?

  /// List of jurisdictions under this jurisdiction
  children Jurisdiction[] @relation("children")

  /// List of taxrate for this jurisdiction
  taxRates TaxRate[]

  /// Defines if the entry is readonly or not
  /// Readonly entries cannot be updated by the client applications
  readonly Boolean @default(true)

  @@index([parentId])
  @@index([name])
  @@index([level])
}

model TaxRate {
  /// Unique local integer identifier (system-input)
  id Int @id @default(autoincrement())

  /// Defines the creation timestamp (system-input)
  createdAt DateTime @default(now())

  /// Defines the modification timestamp (system-input)
  updatedAt DateTime @updatedAt

  /// Defines deletion timestamp (system-input)
  deletedAt DateTime?

  /// The tax rate expressed as a percentage (e.g., 0.075 for 7.5%). 
  /// The database type Decimal(10, 6) ensures precise storage of the value.
  percentRate Decimal @db.Decimal(10, 6)

  /// An amount of tax charged as a flat fee, regardless of the price 
  /// (less common for sales tax but used for things like excise taxes).
  fixedRate Decimal @db.Decimal(10, 6)

  /// A note about the tax (e.g., "State General Sales Tax").
  description String?

  /// These fields are crucial for historical accuracy. 
  /// They define the time range during which this specific rate was or is valid. 
  /// Tax rates change frequently, so the system must know which rate to apply 
  /// for a transaction on any given date.
  effectiveFrom DateTime
  effectiveTo   DateTime?

  /// Jurisdiction relation 
  jurisdiction Jurisdiction @relation(fields: [jurisdictionId], references: [id])

  /// Jurisdiction id
  jurisdictionId Int

  /// Produc type 
  productType ProductType @relation(fields: [productTypeId], references: [id])

  /// Product type id
  productTypeId Int

  /// Defines if the entry is readonly or not
  /// Readonly entries cannot be updated by the client applications
  readonly Boolean @default(false)

  @@unique([jurisdictionId, productTypeId, effectiveFrom])
  @@index([jurisdictionId])
  @@index([productTypeId])
  @@index([effectiveFrom])
  @@index([effectiveTo])
}

// Logs 
enum OperationType {
  READ
  WRITE
  UPDATE
  DELETE
}

enum OperatorType {
  USER
  SYSTEM
}

model Log {
  id Int @id @default(autoincrement())

  /// Log timestamp
  timestamp DateTime @default(now())

  /// The operator who executed this operation
  operatorId String @db.Uuid

  /// Operator type (system/user)
  operatorType OperatorType

  /// Operation type 
  operationType OperationType

  /// Record/model/database table name
  recordName String

  /// Record/entry id
  recordId Int

  /// Defines what changes are made
  change Json

  /// Defines if the entry is readonly or not
  /// Readonly entries cannot be updated by the client application
  readonly Boolean @default(true)

  @@index([operatorId, operatorType])
  @@index([recordName, recordId])
  @@index([timestamp])
}
