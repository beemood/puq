/// IMS | Inventeory management system database

generator client {
  provider = "prisma-client-js"
  output   = "../generated"
}

generator zodGenerator {
  provider = "zod-generator"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          Int       @id @default(autoincrement())
  uuid        String    @unique @db.Uuid
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  updatedBy   User?     @relation("updatedUsers", fields: [updatedById], references: [id]) @ignore
  updatedById Int?
  readonly    Boolean   @default(false)

  displayName String?

  updatedUsers User[] @relation("updatedUsers") @ignore
  updatedCustomers              Customer[]              @ignore
  updatedStores                 Store[]                 @ignore
  updatedShelves                Shelf[]                 @ignore
  updatedCategories             Category[]              @ignore
  updatedTags                   Tag[]                   @ignore
  updatedProducttags            ProductTag[]            @ignore
  updatedProducts               Product[]               @ignore
  updatedQuantities             Quantity[]              @ignore
  updatedSerialnumbers          SerialNumber[]          @ignore
  updatedPrices                 Price[]                 @ignore
  updatedDiscounts              Discount[]              @ignore
  updatedProducttypes           ProductType[]           @ignore
  updatedJurisdictions          Jurisdiction[]          @ignore
  updatedTaxrates               TaxRate[]               @ignore
  updatedCustomerGroups         CustomerGroup[]         @ignore
  updatedPriceLevels            PriceLevel[]            @ignore
  updatedProductDiscounts       ProductDiscount[]       @ignore
  updatedStoreDiscounts         StoreDiscount[]         @ignore
  updatedCategoryDiscounts      CategoryDiscount[]      @ignore
  updatedProductTypeDiscounts   ProductTypeDiscount[]   @ignore
  updatedCustomerDiscounts      CustomerDiscount[]      @ignore
  updatedCustomerGroupDiscounts CustomerGroupDiscount[] @ignore
  updatedAttributes             Attribute[]             @ignore
  updatedProductAttributes      ProductAttribute[]      @ignore
}

model Customer {
  id          Int       @id @default(autoincrement())
  uuid        String    @unique @db.Uuid
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  updatedBy   User?     @relation(fields: [updatedById], references: [id]) @ignore
  updatedById Int?
  readonly    Boolean   @default(false)

  discounts CustomerDiscount[]
  prices    Price[]
}

model CustomerGroup {
  id          Int       @id @default(autoincrement())
  uuid        String    @unique @db.Uuid
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  updatedBy   User?     @relation(fields: [updatedById], references: [id]) @ignore
  updatedById Int?
  readonly    Boolean   @default(false)

  displayName String?

  discounts CustomerGroupDiscount[]
  prices    Price[]
}

model Store {
  id          Int       @id @default(autoincrement())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  updatedBy   User?     @relation(fields: [updatedById], references: [id]) @ignore
  updatedById Int?
  readonly    Boolean   @default(false)

  name        String  @unique @db.VarChar(255)
  slug        String  @unique @default(uuid(7))
  description String?

  priceLevel   PriceLevel @relation(fields: [priceLevelId], references: [id])
  priceLevelId Int

  quantities Quantity[]
  serials    SerialNumber[]
  shelves    Shelf[]
  discounts  StoreDiscount[]
  prices     Price[]

  @@index([name])
  @@index([slug])
}

model Shelf {
  id          Int       @id @default(autoincrement())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  updatedBy   User?     @relation(fields: [updatedById], references: [id]) @ignore
  updatedById Int?
  readonly    Boolean   @default(false)

  name        String  @db.VarChar(255)
  description String?
  aisle       String  @db.VarChar(255)
  rack        Int
  level       Int

  store   Store @relation(fields: [storeId], references: [id])
  storeId Int

  @@unique([name, storeId])
  @@unique([storeId, aisle, rack, level])
  @@index([storeId])
  @@index([aisle, rack, level])
}

model Category {
  id          Int       @id @default(autoincrement())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  updatedBy   User?     @relation(fields: [updatedById], references: [id]) @ignore
  updatedById Int?
  readonly    Boolean   @default(false)

  name        String  @unique @db.VarChar(255)
  slug        String  @unique @default(uuid(7))
  description String?

  parent    Category?          @relation("children", fields: [parentId], references: [id])
  parentId  Int?
  children  Category[]         @relation("children")
  products  Product[]
  discounts CategoryDiscount[]

  @@index([parentId])
  @@index([name])
  @@index([slug])
}

model Tag {
  id          Int       @id @default(autoincrement())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  updatedBy   User?     @relation(fields: [updatedById], references: [id]) @ignore
  updatedById Int?
  readonly    Boolean   @default(false)

  name String @unique @db.VarChar(255)
  slug String @unique @default(uuid(7))

  tags ProductTag[]

  @@index([name])
}

model ProductTag {
  id          Int       @id @default(autoincrement())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  updatedBy   User?     @relation(fields: [updatedById], references: [id]) @ignore
  updatedById Int?
  readonly    Boolean   @default(false)

  product   Product @relation(fields: [productId], references: [id])
  productId Int

  tag   Tag @relation(fields: [tagId], references: [id])
  tagId Int

  @@unique([productId, tagId])
  @@index([productId])
  @@index([tagId])
}

enum AttributeValueType {
  TEXT
  NUMBER
}

model Attribute {
  id          Int       @id @default(autoincrement())
  uuid        String    @default(uuid()) @db.Uuid
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  updatedBy   User?     @relation(fields: [updatedById], references: [id]) @ignore
  updatedById Int?
  readonly    Boolean   @default(false)

  name        String             @unique @db.VarChar(255)
  description String?
  valueType   AttributeValueType @default(TEXT)

  products ProductAttribute[]
}

model ProductAttribute {
  id          Int       @id @default(autoincrement())
  uuid        String    @default(uuid()) @db.Uuid
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  updatedBy   User?     @relation(fields: [updatedById], references: [id]) @ignore
  updatedById Int?
  readonly    Boolean   @default(false)

  value String

  attribute   Attribute @relation(fields: [attributeId], references: [id])
  attributeId Int

  product   Product @relation(fields: [productId], references: [id])
  productId Int

  @@unique([attributeId, productId])
}

model Product {
  id          Int       @id @default(autoincrement())
  uuid        String    @default(uuid()) @db.Uuid
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  updatedBy   User?     @relation(fields: [updatedById], references: [id]) @ignore
  updatedById Int?
  readonly    Boolean   @default(false)

  name        String             @unique @db.VarChar(255)
  slug        String             @unique @default(uuid(7))
  description String?
  sku         String             @unique @db.VarChar(255)
  upc         String             @unique @db.VarChar(255)
  model       String?            @db.VarChar(255)
  category    Category?          @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  categoryId  Int?
  attributes  ProductAttribute[]

  type       ProductType?   @relation(fields: [typeId], references: [id], onDelete: SetNull)
  typeId     Int?
  parent     Product?       @relation("variants", fields: [parentId], references: [id], onDelete: SetNull)
  parentId   Int?
  variants   Product[]      @relation("variants")
  quantities Quantity[]
  serials    SerialNumber[]
  prices     Price[]
  tags       ProductTag[]

  discounts ProductDiscount[]

  @@index([categoryId])
  @@index([typeId])
  @@index([parentId])
  @@index([sku])
  @@index([upc])
  @@index([name])
}

model Quantity {
  id          Int       @id @default(autoincrement())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  updatedBy   User?     @relation(fields: [updatedById], references: [id]) @ignore
  updatedById Int?

  quantity    Int
  minQuantity Int?

  product   Product @relation(fields: [productId], references: [id])
  productId Int

  store   Store @relation(fields: [storeId], references: [id])
  storeId Int

  readonly Boolean @default(false)

  @@unique([storeId, productId])
  @@index([productId])
  @@index([storeId])
}

model SerialNumber {
  id          Int       @id @default(autoincrement())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  updatedBy   User?     @relation(fields: [updatedById], references: [id]) @ignore
  updatedById Int?
  readonly    Boolean   @default(false)

  serial  String  @unique
  inStock Boolean @default(true)

  product   Product @relation(fields: [productId], references: [id])
  productId Int

  store   Store @relation(fields: [storeId], references: [id])
  storeId Int

  @@index([productId])
  @@index([storeId])
  @@index([inStock])
}

model PriceLevel {
  id          Int       @id @default(autoincrement())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  updatedBy   User?     @relation(fields: [updatedById], references: [id]) @ignore
  updatedById Int?
  readonly    Boolean   @default(false)

  name        String  @unique
  description String?

  taxrate   TaxRate @relation(fields: [taxRateId], references: [id])
  taxRateId Int

  prices Price[]
  stores Store[]

  @@index([name])
}

model Price {
  id          Int       @id @default(autoincrement())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  updatedBy   User?     @relation(fields: [updatedById], references: [id]) @ignore
  updatedById Int?
  readonly    Boolean   @default(false)

  price     Decimal   @db.Decimal(10, 2)
  startDate DateTime
  endDate   DateTime?

  product   Product @relation(fields: [productId], references: [id])
  productId Int

  customer   Customer? @relation(fields: [customerId], references: [id])
  customerId Int?

  store   Store? @relation(fields: [storeId], references: [id])
  storeId Int?

  customerGroup   CustomerGroup? @relation(fields: [customerGroupId], references: [id])
  customerGroupId Int?

  priceLevel   PriceLevel? @relation(fields: [priceLevelId], references: [id])
  priceLevelId Int?

  @@unique([productId, startDate, priceLevelId, storeId, customerGroupId, customerId])
  @@index([productId])
  @@index([customerId])
  @@index([storeId])
  @@index([customerGroupId])
  @@index([priceLevelId])
  @@index([startDate])
  @@index([endDate])
}

enum DiscountValueType {
  FIXED
  PERCENT
}

model Discount {
  id          Int       @id @default(autoincrement())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  updatedBy   User?     @relation(fields: [updatedById], references: [id]) @ignore
  updatedById Int?
  readonly    Boolean   @default(false)

  name        String            @unique
  code        String            @unique
  description String?
  value       Decimal?          @db.Decimal(10, 2)
  valueType   DiscountValueType @default(PERCENT)
  startDate   DateTime
  endDate     DateTime?

  minQuantity Int?
  minSubtotal Decimal? @db.Decimal(10, 2)

  products       ProductDiscount[]       @ignore
  stores         StoreDiscount[]         @ignore
  categories     CategoryDiscount[]      @ignore
  productTypes   ProductTypeDiscount[]   @ignore
  customers      CustomerDiscount[]      @ignore
  customerGroups CustomerGroupDiscount[] @ignore

  @@index([name])
  @@index([code])
  @@index([startDate, endDate])
}

model ProductDiscount {
  id          Int       @id @default(autoincrement())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  updatedBy   User?     @relation(fields: [updatedById], references: [id]) @ignore
  updatedById Int?
  readonly    Boolean   @default(false)

  product   Product @relation(fields: [productId], references: [id])
  productId Int

  discount   Discount @relation(fields: [discountId], references: [id])
  discountId Int

  priority Int @default(0)

  @@unique([productId, discountId])
  @@index([productId])
}

model StoreDiscount {
  id          Int       @id @default(autoincrement())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  updatedBy   User?     @relation(fields: [updatedById], references: [id]) @ignore
  updatedById Int?
  readonly    Boolean   @default(false)

  discount   Discount @relation(fields: [discountId], references: [id])
  discountId Int

  store   Store @relation(fields: [storeId], references: [id])
  storeId Int

  priority Int @default(0)

  @@unique([storeId, discountId])
  @@index([storeId])
}

model CategoryDiscount {
  id          Int       @id @default(autoincrement())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  updatedBy   User?     @relation(fields: [updatedById], references: [id]) @ignore
  updatedById Int?
  readonly    Boolean   @default(false)

  category   Category @relation(fields: [categoryId], references: [id])
  categoryId Int

  discount   Discount @relation(fields: [discountId], references: [id])
  discountId Int

  priority Int @default(0)

  @@unique([categoryId, discountId])
  @@index([categoryId])
}

model ProductTypeDiscount {
  id          Int       @id @default(autoincrement())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  updatedBy   User?     @relation(fields: [updatedById], references: [id]) @ignore
  updatedById Int?
  readonly    Boolean   @default(false)

  productType   ProductType @relation(fields: [productTypeId], references: [id])
  productTypeId Int

  discount   Discount @relation(fields: [discountId], references: [id])
  discountId Int

  priority Int @default(0)

  @@unique([productTypeId, discountId])
  @@index([productTypeId])
}

model CustomerDiscount {
  id          Int       @id @default(autoincrement())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  updatedBy   User?     @relation(fields: [updatedById], references: [id]) @ignore
  updatedById Int?
  readonly    Boolean   @default(false)

  customer   Customer @relation(fields: [customerId], references: [id])
  customerId Int

  discount   Discount @relation(fields: [discountId], references: [id])
  discountId Int

  priority Int @default(0)

  @@unique([customerId, discountId])
  @@index([customerId])
}

model CustomerGroupDiscount {
  id          Int       @id @default(autoincrement())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  updatedBy   User?     @relation(fields: [updatedById], references: [id]) @ignore
  updatedById Int?
  readonly    Boolean   @default(false)

  customerGroup   CustomerGroup @relation(fields: [customerGroupId], references: [id])
  customerGroupId Int

  discount   Discount @relation(fields: [discountId], references: [id])
  discountId Int

  priority Int @default(0)

  @@unique([customerGroupId, discountId])
  @@index([customerGroupId])
}

// Tax tables

/// The ProductType model defines categories of goods or services.
/// In tax systems, different types of products are often taxed 
/// at different rates or might be exempt.
/// - General Merchandise (Tangible Goods): The default category for physical goods 
///   at the standard retail rate.	State + County + City Rate (e.g., 7.5%)
/// - Non-essential Clothing	Clothing that is not eligible for exemptions
///  (often high-priced or specialized).	State + County + City Rate (e.g., 7.5%)
/// - Prepared Food	Food that is ready for immediate consumption, typically
///   sold by restaurants or delis.	Often the General Rate, but sometimes 
///   a Higher rate (e.g., 10%)
/// - Alcoholic Beverages	Always taxable, frequently subject to 
///   the General Rate plus additional excise taxes.	General Rate + Excise Taxes
/// - Tobacco/Vape Products	Always taxable and subject to the General
///   Rate plus additional excise taxes.	General Rate + Excise Taxes
/// - Digital Goods/Software	Prewritten software, streaming services, 
///   and digital downloads. Taxability varies widely.	
///   General Rate (in many states/jurisdictions)
model ProductType {
  id          Int       @id @default(autoincrement())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  updatedBy   User?     @relation(fields: [updatedById], references: [id]) @ignore
  updatedById Int?
  readonly    Boolean   @default(true)

  name        String  @unique @db.VarChar(255)
  description String?

  products  Product[]
  rates     TaxRate[]
  discounts ProductTypeDiscount[]

  @@index([name])
}

model Jurisdiction {
  id          Int       @id @default(autoincrement())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  updatedBy   User?     @relation(fields: [updatedById], references: [id]) @ignore
  updatedById Int?
  readonly    Boolean   @default(true)

  code     String         @unique
  name     String
  level    String
  parent   Jurisdiction?  @relation("children", fields: [parentId], references: [id])
  parentId Int?
  children Jurisdiction[] @relation("children")
  rates    TaxRate[]

  @@index([parentId])
  @@index([name])
  @@index([level])
}

model TaxRate {
  id          Int       @id @default(autoincrement())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  updatedBy   User?     @relation(fields: [updatedById], references: [id]) @ignore
  updatedById Int?
  readonly    Boolean   @default(false)

  name        String  @unique
  description String?

  percentRate Decimal @default(0.00) @db.Decimal(10, 6)
  fixedRate   Decimal @default(0.00) @db.Decimal(10, 6)

  startDate DateTime
  endDate   DateTime?

  jurisdiction   Jurisdiction @relation(fields: [jurisdictionId], references: [id])
  jurisdictionId Int

  productType   ProductType @relation(fields: [productTypeId], references: [id])
  productTypeId Int

  priceLevels PriceLevel[]

  @@unique([jurisdictionId, productTypeId, startDate])
  @@index([jurisdictionId])
  @@index([productTypeId])
  @@index([startDate])
  @@index([endDate])
}

enum OperatorType {
  USER
  SYSTEM
}

model Log {
  id            Int          @id @default(autoincrement())
  readonly      Boolean      @default(true)
  timestamp     DateTime     @default(now())
  operatorId    String?      @db.Uuid
  operatorType  OperatorType @default(SYSTEM)
  operationName String
  recordName    String
  recordId      Int?
  difference    Json?
  successful    Boolean      @default(true)

  @@index([operatorId, operatorType])
  @@index([recordName, recordId])
  @@index([timestamp])
}
